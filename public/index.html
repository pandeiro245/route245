<!DOCTYPE html>
<html>
<head>
  <title>Sample</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
 
    #street-view {
      height: 50%;
    }
    #map-view {
      height: 50%;
    }


#over-view{
  position: absolute;
  top: 0;
  right: 0;
  width: 300px;
  height: 200px;
  background: #ccc;
  z-index: 99999;
}
  </style>
</head>
<body>
 
<div id="street-view"></div>
<div id="map-view"></div>
<div id="over-view">残り24:00</div>
 
<script>
if(location.host == 'route245.herokuapp.com') {
  WAIT_SECOND = 5;
} else {
  WAIT_SECOND = 5;
}
const LIMIT = (60 / WAIT_SECOND) * 24;
const START_LAT_LNG = {lat: 35.6259742, lng: 139.7231077}; // 五反田
// const START_LAT_LNG = {lat: 35.844944, lng: 140.661698}; // 土善旅館
// const START_LAT_LNG = {lat: 35.1680743, lng: 139.8199233}; // 金谷ベース
// const START_LAT_LNG = {lat: 35.6626753, lng: 139.7308336}; // roppongi
// const START_LAT_LNG = {lat: 35.66916851878442, lng: 139.7002243543353}; // yoyogi park
// const START_LAT_LNG = {lat: 35.712996, lng: 139.7049736}; // takadano baba
// const START_LAT_LNG = {lat: 35.712996, lng: 139.7048636}; // takadano baba

const START_HEADING = 270; // 開始時の方角
let panorama;
locations = {};



// GoogleMapApi 読み込み時にcallbackで呼び出される
function initMap() {
  let Links, count = 0, timer_id;

  // ストリートビューの表示
  panorama = new google.maps.StreetViewPanorama(
    document.getElementById('street-view'), {
      position: START_LAT_LNG,
      pov: {
        heading: START_HEADING,
        pitch: 0
      },
      zoom: 1
    }
  );

  map = new google.maps.Map(document.getElementById("map-view"), {
    zoom : 18,
    center: new google.maps.LatLng(START_LAT_LNG.lat, START_LAT_LNG.lng)
  });

  // 画面内のリンクを取得
  Links = panorama.getLinks();

  // ストリートビューの状態が変更されるたびに実行される
  google.maps.event.addListener(panorama, 'status_changed', function () {
    if (panorama.getStatus() == "OK") {
      Links = panorama.getLinks();

      if (count > LIMIT) {
        alert('24分集中完了！');
        location.reload();
      }

      setTimeout(
        function () {
          let target = 0;
          lat = panorama.getPosition()["lat"]();
          lng = panorama.getPosition()["lng"]();
          key = lat + ',' + lng;

          map.panTo(new google.maps.LatLng(lat, lng))

          marker = new google.maps.Marker({ // マーカーの追加
            position: {lat: lat, lng: lng}, // マーカーを立てる位置を指定
            map: map // マーカーを立てる地図を指定
          });

          //現在向ている方向に近いlinkを選択
          let val = 360;
          let currentPov = panorama.getPov();
          Links.forEach(function (element, index) {
            let ans = Math.abs(currentPov.heading - element.heading);
            if (val > ans) {
              val = ans;
              target = index;
            }
          });

          if(typeof(locations[key]) != 'undefined') {
            if(typeof(locations[key][target]) != 'undefined') {
              if(target != 0) {
                target -= 1;
              } else {
                target = Links.length - 1;
              }
              console.log('more than twice')
            } else {
              console.log('first direction')
            }
          } else {
            console.log('first spot')
          }

          // 次に移動するLink先に向きを変える
          panorama.setPov({
            heading: Links[target].heading,
            pitch: 0
          });
          // 次のストリートビューに移動する
          panorama.setPano(Links[target]['pano']);
          count++;
          remain = 24 * 60 - count * 5;
          min = parseInt(remain / 60);
          sec = remain - min * 60;
          if(typeof(locations[lat + ',' + lng]) == 'undefined'){
            locations[lat + ',' + lng] = {};
          }
          if(typeof(locations[lat + ',' + lng][target]) == 'undefined'){
            locations[lat + ',' + lng][target] = 1
          }else{
            locations[lat + ',' + lng][target] += 1
          }
          document.getElementById('over-view').innerHTML = '残り'+ min + ':' + sec + '<br/>lat: ' + lat + ', lng: ' + lng;
        },
        WAIT_SECOND * 1000
      );
    }
  });
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3dGkF7iYkFxxqzf5YS7Q5FCqWx0oq4vI&callback=initMap&v=3&libraries=drawing"
    async defer></script>
</body>
</html>
